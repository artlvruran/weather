{% extends "base.html" %}

{% block content %}
    <div id="cover">
      <form name="search_map" action="" method="post">
        <div class="tb">
          <div class="td"><input type="text" placeholder="Search" required name="search"></div>
          <div class="td" id="s-cover">
            <button type="submit">
              <div id="s-circle"></div>
            </button>
          </div>
        </div>
      </form>
    </div>
    <div style="width: 100%; height: 80vh; border-radius:20px;" id="map"></div>
    <script>
        var city = { lng: {{lon}}, lat:{{lat}}}
        var map = tt.map({
            key: 'IP5RMG2Jx0ZOHocnOe1fG6TFf8t5FAf3',
            container: 'map',
            center: city,
            zoom:13
        })

        var cloudSource = {
            type: 'raster',
            tiles: ['https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid={{WEATHER_API}}'],
            tileSize: 256,
            minZoom: 0,
            maxZoom: 12,
            attribution: 'OpenWeatherMap.Org'
        }
        var rainSource = {
            type: 'raster',
            tiles: ['https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid={{WEATHER_API}}'],
            tileSize: 256,
            minZoom: 0,
            maxZoom: 12,
            attribution: 'OpenWeatherMap.Org'
        }
        var tempSource = {
            type: 'raster',
            tiles: ['https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid={{WEATHER_API}}'],
            tileSize: 256,
            minZoom: 0,
            maxZoom: 12,
            attribution: 'OpenWeatherMap.Org'
        }
        var cloudLayer = {
            'id': 'cloud_layer',
            'type': 'raster',
            'source': 'cloud_source',
            'layout': { 'visibility': 'visible'}
        }
        var rainLayer = {
            'id': 'rain_layer',
            'type': 'raster',
            'source': 'rain_source',
            'layout': { 'visibility': 'visible'}
        }
        var tempLayer = {
            'id': 'temp_layer',
            'type': 'raster',
            'source': 'temp_source',
            'layout': { 'visibility': 'visible'}
        }

        map.on('load', function(){
            map.addSource('cloud_source', cloudSource)
            map.addLayer(cloudLayer)

            map.addSource('rain_source', rainSource)
            map.addLayer(rainLayer)

            map.addSource('temp_source', tempSource)
            map.addLayer(tempLayer)
        })

        map.on('click', function (event) {
            console.log(event.lngLat)
            weatherForCityAround(event.lngLat)
        })
        function createDOM(city) {
            let div = document.createElement('div')

            let temp = document.createTextNode(((city.main.temp.toFixed(0) - 32) * 5 / 9).toFixed(2) + ' °С')

            div.appendChild(temp)

            let icon = city.weather[0].icon
            let image = document.createElement('img')
            image.src = 'https://openweathermap.org/img/wn/' + icon + '@2x.png'
            div.appendChild(image)

            let bio = document.createTextNode(city.weather[0].description)
            div.appendChild(bio)

            return div
        }

        async function weatherForCityAround(lngLat) {
            var url = 'http://api.openweathermap.org/data/2.5/weather?units=imperial&lat={lat}&lon={lon}&lang=en&appid={{WEATHER_API}}'
            url = url.replace('{lat}', lngLat.lat)
            url = url.replace('{lon}', lngLat.lng)
            let weatherResponse = await fetch(url)
            let weatherData = await weatherResponse.json()
            console.log(weatherData)
            var popup = new tt.Popup({maxWidth: 'none'})
                .setDOMContent(createDOM(weatherData))
                .setLngLat(weatherData.coord)
                .addTo(map)
        }
    </script>
{% endblock %}